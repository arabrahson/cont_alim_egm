<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Recetario Escolar - Gasto Total Semana</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
<style>
  :root{
    --accent:#2563eb;
    --card:#ffffff;
    --muted:#6b7280;
    --border:#e5e7eb;
    --bg:#f8fafc;
    --success:#10b981;
  }
  html,body{height:100%}
  body{
    font-family:Inter, Arial, sans-serif;
    margin:18px;
    color:#111;
    background:linear-gradient(180deg,#fbfdff 0%,var(--bg) 100%);
  }
  h1{margin:0 0 6px;font-weight:600}
  .grid{display:grid;grid-template-columns:1fr;gap:18px}
  .card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:10px;padding:14px;
    box-shadow:0 6px 18px rgba(16,24,40,0.03);
  }
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{border:1px solid var(--border);padding:8px;text-align:center}
  th{background:#f3f4f6;font-weight:600}
  input[type=number], input[type=text], select, textarea{padding:8px;border:1px solid #d1d5db;border-radius:8px;font-size:14px}
  .row{display:flex;gap:8px;align-items:center}
  .btn{background:var(--accent);color:white;padding:8px 12px;border-radius:8px;border:none;cursor:pointer; font-weight:600}
  .btn.secondary{background:#374151}
  .small{font-size:12px}
  .muted{color:var(--muted)}
  .flex-between{display:flex;justify-content:space-between;align-items:center}
  .wide{width:100%}
  .split{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .stat{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:10px;border-radius:8px;background:#fbfdff;border:1px solid var(--border)}
  .stat strong{font-size:18px}
  .section-title{font-size:15px;margin:6px 0 10px;font-weight:600}
  .muted-block{color:var(--muted);font-size:13px;margin-bottom:8px}
  .compact-table th,.compact-table td{padding:6px;font-size:13px}
  .pill{display:inline-block;padding:6px 8px;border-radius:999px;background:#eef2ff;color:var(--accent);font-weight:600;font-size:12px}
  /* responsive */
  @media(min-width:900px){ .grid{grid-template-columns: 1fr 420px} .split{grid-template-columns:1fr 1fr} }
</style>
</head>
<body>
<h1>Recetario Escolar — Gasto & Compras</h1>
<p class="muted">App local (guarda todo en Local Storage). Ingresa matrícula y precios por semana. Genera reportes diarios, semanales y mensuales, además de materiales totales y reporte de compra.</p>

<div class="grid">
  <div class="card">
    <div class="flex-between">
      <div>
        <h2 style="margin:0">1) Configuración</h2>
        <div class="muted-block small">Semana activa y precios por ingrediente (Kg, L, pza, etc.). Guarda para la semana seleccionada.</div>
      </div>
      <div class="row">
        <label class="small">Semana: <input id="semanaInput" type="number" min="1" value="1" style="width:90px"></label>
        <button class="btn" id="cargarSemana">Cargar precios</button>
      </div>
    </div>

    <div style="margin-top:10px; overflow:auto; max-height:320px;">
      <table id="preciosTable">
        <thead>
          <tr><th>Ingrediente</th><th>Clase</th><th>Unidad</th><th>Precio (por unidad)</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div style="margin-top:10px" class="row">
      <button class="btn" id="guardarPrecios">Guardar precios</button>
      <button class="btn secondary" id="toggleAuto">Auto-guardar: OFF</button>
      <button class="btn secondary" id="exportBackup">Exportar backup</button>
      <button class="btn secondary" id="importBackup">Importar backup</button>
    </div>
  </div>

  <div class="card">
    <div class="flex-between">
      <div>
        <h2 style="margin:0">2) Menús y planificación</h2>
        <div class="muted-block small">Selecciona menús para cada día y guarda matrícula (personas o lista de IDs).</div>
      </div>
    </div>

    <div style="display:flex;gap:12px;margin-top:8px" class="split">
      <div>
        <div style="max-height:220px;overflow:auto;border-radius:8px;padding:6px">
          <h3 class="section-title">Menús (20)</h3>
          <ul id="menusList" class="small muted"></ul>
        </div>
      </div>

      <div>
        <label>Día:
          <select id="diaSelect">
            <option value="lunes">Lunes</option>
            <option value="martes">Martes</option>
            <option value="miercoles">Miércoles</option>
            <option value="jueves">Jueves</option>
            <option value="viernes">Viernes</option>
          </select>
        </label>
        <label style="margin-left:8px">Semana:
          <input id="diaSemana" type="number" min="1" value="1" style="width:80px">
        </label>

        <div style="margin-top:8px">
          <label>Matrícula (número o IDs coma): <input id="matriculaInput" type="text" class="wide" placeholder="ej: 28 o 101,102,103"></label>
        </div>

        <div style="margin-top:8px">
          <label>Selecciona menús (Ctrl/Cmd+click):</label>
          <select id="menuSelect" multiple size="8" style="width:100%;margin-top:6px"></select>
        </div>

        <div style="margin-top:8px" class="row">
          <button class="btn" id="guardarDia">Guardar día</button>
          <button class="btn secondary" id="cargarDia">Cargar día</button>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2 style="margin:0">3) Reportes</h2>
    <div class="muted-block small">Genera reporte diario, gasto semanal, resumen mensual, materiales y lista de compra.</div>

    <div style="display:flex;gap:8px;margin-top:8px">
      <button class="btn" id="generarReporte">Generar reporte</button>
      <button class="btn" id="exportPDF">Exportar PDF</button>
      <button class="btn secondary" id="limpiarDatos">Limpiar Local Storage</button>
    </div>

    <div id="reporteArea" style="margin-top:12px;overflow:auto;max-height:520px"></div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
/* ================= Menús (los 20 que pasaste) ================= */
const MENUS = [
  {id:1,name:'SÁNDWICH O TACO DE HUEVO CON ESPINACA Y QUESO , ENSALADA DULCE , BEBIDA',items:[
    {i:'Pan integral',clase:'Cereales',cantidad:0.1,unidad:'Paquetes'},
    {i:'Huevo',clase:'Proteínas',cantidad:0.035,unidad:'Kg'},
    {i:'Espinaca',clase:'Vegetales',cantidad:0.03,unidad:'Kg'},
    {i:'Cebolla',clase:'Vegetales',cantidad:0.0005,unidad:'Kg'},
    {i:'Aceite',clase:'Aceites',cantidad:0.0003,unidad:'L'},
    {i:'Queso panela',clase:'Lácteos',cantidad:0.012,unidad:'Kg'},
    {i:'Lechuga',clase:'Vegetales',cantidad:0.005,unidad:'Kg'},
    {i:'Jitomate',clase:'Vegetales',cantidad:0.005,unidad:'Kg'},
    {i:'Zanahoria',clase:'Vegetales',cantidad:0.025,unidad:'Kg'},
    {i:'Piña',clase:'Frutas',cantidad:0.08,unidad:'Kg'},
    {i:'Cacahuate',clase:'Semillas',cantidad:0.005,unidad:'Kg'},
    {i:'Yogurth natural',clase:'Lácteos',cantidad:0.006,unidad:'L'},
    {i:'Agua natural',clase:'Bebidas',cantidad:0.0125,unidad:'Garrafones'},
    {i:'Opción tortilla de maíz',clase:'Cereales',cantidad:0.06,unidad:'Kg'}
  ]},
  {id:2,name:'BISTEC CON QUESO PANELA Y NOPALES EN SALSA DE GUAJILLO',items:[
    {i:'Bistec de res',clase:'Proteínas',cantidad:0.0275,unidad:'Kg'},
    {i:'Nopal',clase:'Vegetales',cantidad:0.05,unidad:'Kg'},
    {i:'Papa',clase:'Vegetales',cantidad:0.04,unidad:'Kg'},
    {i:'Queso panela',clase:'Lácteos',cantidad:0.01,unidad:'Kg'},
    {i:'Jitomate',clase:'Vegetales',cantidad:0.03,unidad:'Kg'},
    {i:'Chile guajillo sin picante',clase:'Otros',cantidad:0.0003,unidad:'Kg'},
    {i:'Ajo',clase:'Vegetales',cantidad:0.0003,unidad:'Kg'},
    {i:'Cebolla',clase:'Vegetales',cantidad:0.0003,unidad:'Kg'},
    {i:'Aceite',clase:'Aceites',cantidad:0.0005,unidad:'L'},
    {i:'Sal',clase:'Otros',cantidad:0.00002,unidad:'Kg'},
    {i:'Frijol',clase:'Proteínas',cantidad:0.0175,unidad:'Kg'},
    {i:'Plátano',clase:'Frutas',cantidad:0.06,unidad:'Kg'},
    {i:'Melón',clase:'Frutas',cantidad:0.07,unidad:'Kg'},
    {i:'Semillas de girasol',clase:'Semillas',cantidad:0.003,unidad:'Kg'}
  ]},
  {id:3,name:'HOT CAKE DE AVENA Y PLÁTANO',items:[
    {i:'Harina integral de trigo',clase:'Cereales',cantidad:0.016,unidad:'Kg'},
    {i:'Hojuelas de avena',clase:'Cereales',cantidad:0.011,unidad:'Kg'},
    {i:'Huevo',clase:'Proteínas',cantidad:0.022,unidad:'Kg'},
    {i:'Plátano',clase:'Frutas',cantidad:0.05,unidad:'Kg'},
    {i:'Aceite',clase:'Aceites',cantidad:0.001,unidad:'L'},
    {i:'Esencia de vainilla',clase:'Otros',cantidad:0.00025,unidad:'L'},
    {i:'Zanahoria',clase:'Vegetales',cantidad:0.035,unidad:'Kg'},
    {i:'Jícama',clase:'Vegetales',cantidad:0.035,unidad:'Kg'}
  ]},
  {id:4,name:'TORTITAS DE POLLO CON VERDURAS',items:[
    {i:'Pechuga de pollo',clase:'Proteínas',cantidad:0.0475,unidad:'Kg'},
    {i:'Ajo',clase:'Vegetales',cantidad:0.0003,unidad:'Kg'},
    {i:'Cebolla',clase:'Vegetales',cantidad:0.0003,unidad:'Kg'},
    {i:'Huevo',clase:'Proteínas',cantidad:0.015,unidad:'Kg'},
    {i:'Calabacita',clase:'Vegetales',cantidad:0.05,unidad:'Kg'},
    {i:'Papa',clase:'Vegetales',cantidad:0.025,unidad:'Kg'},
    {i:'Aceite',clase:'Aceites',cantidad:0.0005,unidad:'L'},
    {i:'Sal',clase:'Otros',cantidad:0.00002,unidad:'Kg'},
    {i:'Tortilla de maíz',clase:'Cereales',cantidad:0.03,unidad:'Kg'},
    {i:'Bolillo integral',clase:'Cereales',cantidad:0.5,unidad:'PZAS'}
  ]},
  {id:5,name:'ENTOMATADAS DE LA MILPA',items:[
    {i:'Tortilla de maíz',clase:'Cereales',cantidad:0.06,unidad:'Kg'},
    {i:'Alverjón refrito',clase:'Proteínas',cantidad:0.009,unidad:'Kg'},
    {i:'Calabacita',clase:'Vegetales',cantidad:0.045,unidad:'Kg'},
    {i:'Zanahoria',clase:'Vegetales',cantidad:0.025,unidad:'Kg'},
    {i:'Queso panela',clase:'Lácteos',cantidad:0.009,unidad:'Kg'},
    {i:'Cebolla',clase:'Vegetales',cantidad:0.0003,unidad:'Kg'}
  ]},
  {id:6,name:'TOSTADA O TACO DE SALPICÓN DE POLLO',items:[
    {i:'Pechuga de pollo',clase:'Proteínas',cantidad:0.03,unidad:'Kg'},
    {i:'Ajo',clase:'Vegetales',cantidad:0.0003,unidad:'Kg'},
    {i:'Cebolla',clase:'Vegetales',cantidad:0.0003,unidad:'Kg'},
    {i:'Queso fresco',clase:'Lácteos',cantidad:0.015,unidad:'Kg'},
    {i:'Lechuga',clase:'Vegetales',cantidad:0.03,unidad:'Kg'},
    {i:'Jitomate',clase:'Vegetales',cantidad:0.025,unidad:'Kg'},
    {i:'Tostada horneada',clase:'Cereales',cantidad:0.05,unidad:'Paquetes'}
  ]},
  {id:7,name:'CALDITO SALUDABLE',items:[
    {i:'Garbanzo',clase:'Proteínas',cantidad:0.023,unidad:'Kg'},
    {i:'Arroz',clase:'Cereales',cantidad:0.003,unidad:'Kg'},
    {i:'Zanahoria',clase:'Vegetales',cantidad:0.02,unidad:'Kg'},
    {i:'Jícama',clase:'Frutas',cantidad:0.07,unidad:'Kg'},
    {i:'Piña',clase:'Frutas',cantidad:0.15,unidad:'Kg'},
    {i:'Cacahuate triturado',clase:'Semillas',cantidad:0.007,unidad:'Kg'}
  ]},
  {id:8,name:'HUEVO A LA MEXICANA',items:[
    {i:'Huevo',clase:'Proteínas',cantidad:0.06,unidad:'Kg'},
    {i:'Jitomate',clase:'Vegetales',cantidad:0.025,unidad:'Kg'},
    {i:'Aceite',clase:'Aceites',cantidad:0.0005,unidad:'L'},
    {i:'Frijol',clase:'Proteínas',cantidad:0.0175,unidad:'Kg'},
    {i:'Melón',clase:'Frutas',cantidad:0.11,unidad:'Kg'},
    {i:'Amaranto',clase:'Otros',cantidad:0.005,unidad:'Kg'}
  ]},
  {id:9,name:'PICADILLO DE LENTEJAS CON MOLIDA DE RES',items:[
    {i:'Lenteja',clase:'Proteínas',cantidad:0.037,unidad:'Kg'},
    {i:'Molida de res',clase:'Proteínas',cantidad:0.008,unidad:'Kg'},
    {i:'Zanahoria',clase:'Vegetales',cantidad:0.05,unidad:'Kg'},
    {i:'Chícharo',clase:'Vegetales',cantidad:0.02,unidad:'Kg'},
    {i:'Arroz',clase:'Cereales',cantidad:0.008,unidad:'Kg'}
  ]},
  {id:10,name:'MOLLETE CON PICO DE GALLO',items:[
    {i:'Bolillo integral',clase:'Cereales',cantidad:0.5,unidad:'PZAS'},
    {i:'Queso panela',clase:'Lácteos',cantidad:0.025,unidad:'Kg'},
    {i:'Frijol',clase:'Proteínas',cantidad:0.02,unidad:'Kg'},
    {i:'Jitomate',clase:'Vegetales',cantidad:0.018,unidad:'Kg'},
    {i:'Cilantro',clase:'Vegetales',cantidad:0.001,unidad:'Kg'}
  ]},
  {id:11,name:'QUESADILLA CAMPIRANA',items:[
    {i:'Tortilla de maíz',clase:'Cereales',cantidad:0.03,unidad:'Kg'},
    {i:'Pechuga de pollo',clase:'Proteínas',cantidad:0.025,unidad:'Kg'},
    {i:'Espinaca',clase:'Vegetales',cantidad:0.037,unidad:'Kg'},
    {i:'Queso oaxaca',clase:'Lácteos',cantidad:0.009,unidad:'Kg'}
  ]},
  {id:12,name:'CALABACITAS CON POLLO Y QUESO',items:[
    {i:'Calabacita',clase:'Vegetales',cantidad:0.072,unidad:'Kg'},
    {i:'Granos de elote',clase:'Vegetales',cantidad:0.01,unidad:'Kg'},
    {i:'Queso fresco',clase:'Lácteos',cantidad:0.005,unidad:'Kg'},
    {i:'Pechuga de pollo',clase:'Proteínas',cantidad:0.025,unidad:'Kg'}
  ]},
  {id:13,name:'ENFRIJOLADAS CON POLLO',items:[
    {i:'Tortilla de maíz',clase:'Cereales',cantidad:0.06,unidad:'Kg'},
    {i:'Pechuga de pollo',clase:'Proteínas',cantidad:0.028,unidad:'Kg'},
    {i:'Queso panela',clase:'Lácteos',cantidad:0.0175,unidad:'Kg'},
    {i:'Arroz',clase:'Cereales',cantidad:0.01,unidad:'Kg'}
  ]},
  {id:14,name:'HUEVO CON EJOTES',items:[
    {i:'Huevo',clase:'Proteínas',cantidad:0.05,unidad:'Kg'},
    {i:'Ejote',clase:'Vegetales',cantidad:0.03,unidad:'Kg'},
    {i:'Lentejas',clase:'Proteínas',cantidad:0.021,unidad:'Kg'},
    {i:'Melón',clase:'Frutas',cantidad:0.12,unidad:'Kg'}
  ]},
  {id:15,name:'TINGA DE ZANAHORIA CON POLLO',items:[
    {i:'Zanahoria',clase:'Vegetales',cantidad:0.045,unidad:'Kg'},
    {i:'Pechuga de pollo',clase:'Proteínas',cantidad:0.03,unidad:'Kg'},
    {i:'Chícharo',clase:'Vegetales',cantidad:0.01,unidad:'Kg'},
    {i:'Frijol',clase:'Proteínas',cantidad:0.0175,unidad:'Kg'},
    {i:'Guayaba',clase:'Frutas',cantidad:0.07,unidad:'Kg'}
  ]},
  {id:16,name:'SOPE CON NOPALES',items:[
    {i:'Harina de maíz nixtamalizado',clase:'Cereales',cantidad:0.0315,unidad:'Kg'},
    {i:'Ajonjolí',clase:'Semillas',cantidad:0.0045,unidad:'Kg'},
    {i:'Nopal crudo',clase:'Vegetales',cantidad:0.018,unidad:'Kg'},
    {i:'Queso panela',clase:'Lácteos',cantidad:0.016,unidad:'Kg'}
  ]},
  {id:17,name:'SOPA DE FIDEO INTEGRAL CON POLLO',items:[
    {i:'Pasta integral',clase:'Cereales',cantidad:0.006,unidad:'Kg'},
    {i:'Pechuga de pollo',clase:'Proteínas',cantidad:0.033,unidad:'Kg'},
    {i:'Zanahoria',clase:'Vegetales',cantidad:0.037,unidad:'Kg'}
  ]},
  {id:18,name:'ENCHILADAS VERDES CON POLLO, QUESO Y VERDURAS',items:[
    {i:'Tortilla de maíz',clase:'Cereales',cantidad:0.06,unidad:'Kg'},
    {i:'Pechuga de pollo',clase:'Proteínas',cantidad:0.015,unidad:'Kg'},
    {i:'Queso fresco',clase:'Lácteos',cantidad:0.005,unidad:'Kg'},
    {i:'Champiñón',clase:'Vegetales',cantidad:0.015,unidad:'Kg'}
  ]},
  {id:19,name:'MILANESA DE RES VERDURAS',items:[
    {i:'Carne molida',clase:'Proteínas',cantidad:0.03,unidad:'Kg'},
    {i:'Papa',clase:'Vegetales',cantidad:0.042,unidad:'Kg'},
    {i:'Brócoli',clase:'Vegetales',cantidad:0.017,unidad:'Kg'}
  ]},
  {id:20,name:'HUEVO CON NOPALES Y PAPA',items:[
    {i:'Huevo',clase:'Proteínas',cantidad:0.025,unidad:'Kg'},
    {i:'Nopal',clase:'Vegetales',cantidad:0.025,unidad:'Kg'},
    {i:'Papa',clase:'Vegetales',cantidad:0.026,unidad:'Kg'},
    {i:'Alubias',clase:'Proteínas',cantidad:0.004,unidad:'Kg'}
  ]}
];

/* ================= Keys and helpers ================= */
const LS_KEYS = { PRECIOS:'rec_precios', PLAN:'rec_plan' };
let autoSave = false;

function uniqueIngredients(){
  const map = new Map();
  MENUS.forEach(m=> m.items.forEach(it=>{
    if(!map.has(it.i)) map.set(it.i,{ingrediente:it.i,clase:it.clase,unidad:it.unidad});
  }));
  return Array.from(map.values());
}

/* ================= UI init ================= */
function initUI(){
  const menusList = document.getElementById('menusList');
  const menuSelect = document.getElementById('menuSelect');
  menusList.innerHTML = '';
  menuSelect.innerHTML = '';
  MENUS.forEach(m=>{
    const li = document.createElement('li');
    li.textContent = `${m.name} — ${m.items.length} insumos`;
    menusList.appendChild(li);
    const opt = document.createElement('option');
    opt.value = m.id;
    opt.textContent = m.name;
    menuSelect.appendChild(opt);
  });
  renderPreciosTable();
}

/* ================= Precios table ================= */
function renderPreciosTable(){
  const tbody = document.querySelector('#preciosTable tbody'); tbody.innerHTML = '';
  const ingredientes = uniqueIngredients();
  const semana = document.getElementById('semanaInput').value;
  const preciosObj = JSON.parse(localStorage.getItem(LS_KEYS.PRECIOS) || '{}');
  const semanaPre = preciosObj[`sem_${semana}`] || {};
  ingredientes.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td style="text-align:left">${r.ingrediente}</td><td>${r.clase}</td><td>${r.unidad}</td>
      <td><input data-ing="${r.ingrediente}" type="number" step="0.01" min="0" value="${(semanaPre[r.ingrediente]!==undefined)? semanaPre[r.ingrediente] : ''}"></td>`;
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll('input[data-ing]').forEach(inp=> inp.addEventListener('input', ()=>{ if(autoSave) guardarPrecios(); }));
}

function guardarPrecios(){
  const semana = document.getElementById('semanaInput').value;
  const filas = Array.from(document.querySelectorAll('#preciosTable tbody tr'));
  const preciosObj = JSON.parse(localStorage.getItem(LS_KEYS.PRECIOS) || '{}');
  preciosObj[`sem_${semana}`] = preciosObj[`sem_${semana}`] || {};
  filas.forEach(f=>{
    const ing = f.cells[0].textContent;
    const val = parseFloat(f.cells[3].querySelector('input').value) || 0;
    preciosObj[`sem_${semana}`][ing]=val;
  });
  localStorage.setItem(LS_KEYS.PRECIOS, JSON.stringify(preciosObj));
  alert('Precios guardados (semana '+semana+')');
}

/* ================= Plan (dias) ================= */
function guardarDia(){
  const dia = document.getElementById('diaSelect').value;
  const semanaAsignada = parseInt(document.getElementById('diaSemana').value) || 1;
  const matriculaRaw = document.getElementById('matriculaInput').value.trim();
  let matriculaArr = [];
  if(matriculaRaw.includes(',')) matriculaArr = matriculaRaw.split(',').map(s=>s.trim()).filter(Boolean);
  else if(matriculaRaw.length>0) matriculaArr = [matriculaRaw];
  const matCount = matriculaArr.length>1 ? matriculaArr.length : (matriculaArr[0]? parseInt(matriculaArr[0]) || 0 : 0);
  const menuIds = Array.from(document.getElementById('menuSelect').selectedOptions).map(o=>parseInt(o.value));
  const plan = JSON.parse(localStorage.getItem(LS_KEYS.PLAN) || '{}');
  plan[`${dia}_${semanaAsignada}`] = { dia, semana: semanaAsignada, matricula: matriculaArr.length>1 ? matriculaArr : matCount, menus: menuIds };
  localStorage.setItem(LS_KEYS.PLAN, JSON.stringify(plan));
  alert('Guardado: '+dia+' (semana '+semanaAsignada+')');
}

function cargarDia(){
  const dia = document.getElementById('diaSelect').value;
  const semanaAsignada = parseInt(document.getElementById('diaSemana').value) || 1;
  const plan = JSON.parse(localStorage.getItem(LS_KEYS.PLAN) || '{}');
  const key = `${dia}_${semanaAsignada}`;
  const obj = plan[key];
  if(!obj){ alert('No hay datos guardados para '+dia+' en la semana '+semanaAsignada); return; }
  document.getElementById('matriculaInput').value = Array.isArray(obj.matricula) ? obj.matricula.join(',') : obj.matricula;
  Array.from(document.getElementById('menuSelect').options).forEach(o=> o.selected = obj.menus.includes(parseInt(o.value)) );
  alert('Cargado '+dia+' (semana '+semanaAsignada+')');
}

/* ================= Report generation ================= */
function getWeeksToSum(currentWeek, n=4){
  // return array of week numbers to sum: current, current-1, ... until n or >0
  const res = [];
  let w = currentWeek;
  for(let i=0;i<n && w>0;i++){ res.push(w); w--; }
  return res;
}

function generarReporte(){
  const semana = parseInt(document.getElementById('semanaInput').value) || 1;
  const plan = JSON.parse(localStorage.getItem(LS_KEYS.PLAN) || '{}');
  const precios = JSON.parse(localStorage.getItem(LS_KEYS.PRECIOS) || '{}');

  // prepare per-day totals (ingredients and cost)
  const days = ['lunes','martes','miercoles','jueves','viernes'];
  const daySummaries = {}; // day -> { totalCost, ingredientes: {ing: qty} }
  days.forEach(d=> daySummaries[d] = { totalCost:0, ingredientes: {} });

  days.forEach(dia=>{
    const key = dia+'_'+semana;
    const obj = plan[key];
    if(!obj) return;
    const mat = Array.isArray(obj.matricula) ? obj.matricula.length : (parseInt(obj.matricula) || 0);
    obj.menus.forEach(mid=>{
      const menu = MENUS.find(m=>m.id===mid);
      if(!menu) return;
      menu.items.forEach(it=>{
        const qty = it.cantidad * mat;
        // accumulate ingredient qty
        daySummaries[dia].ingredientes[it.i] = (daySummaries[dia].ingredientes[it.i] || 0) + qty;
        // cost using prices for the target semana
        const price = (precios[`sem_${semana}`] || {})[it.i] || 0;
        daySummaries[dia].totalCost += price * qty;
      });
    });
  });

  // Build week totals (sum of days)
  let totalSemana = 0;
  const ingredientesSemana = {}; // ing -> {totalQty, unidad, clase}
  days.forEach(d=>{
    const ds = daySummaries[d];
    totalSemana += ds.totalCost;
    Object.keys(ds.ingredientes).forEach(ing=>{
      const qty = ds.ingredientes[ing];
      const meta = findIngredientMeta(ing);
      if(!ingredientesSemana[ing]) ingredientesSemana[ing] = { totalQty:0, unidad:meta.unidad, clase:meta.clase };
      ingredientesSemana[ing].totalQty += qty;
    });
  });

  // Monthly accumulation (sum last 4 weeks including current if exist)
  const weeksToSum = getWeeksToSum(semana, 4);
  let totalMes = 0;
  const ingredientesMes = {}; // ing -> totalQty across weeks
  weeksToSum.forEach(wk=>{
    // for each day keys in plan, add costs and ingredient qty using precios of that week
    ['lunes','martes','miercoles','jueves','viernes'].forEach(d=>{
      const key = d+'_'+wk;
      const obj = plan[key];
      if(!obj) return;
      const mat = Array.isArray(obj.matricula) ? obj.matricula.length : (parseInt(obj.matricula) || 0);
      obj.menus.forEach(mid=>{
        const menu = MENUS.find(m=>m.id===mid);
        if(!menu) return;
        menu.items.forEach(it=>{
          const qty = it.cantidad * mat;
          // price lookup by week wk
          const price = (precios[`sem_${wk}`] || {})[it.i] || 0;
          totalMes += price * qty;
          if(!ingredientesMes[it.i]) ingredientesMes[it.i] = { totalQty:0, unidad:it.unidad, clase:it.clase };
          ingredientesMes[it.i].totalQty += qty;
        });
      });
    });
  });

  // Purchase report for the week (use precios of the chosen semana for cost)
  const compra = [];
  Object.keys(ingredientesSemana).forEach(ing=>{
    const meta = ingredientesSemana[ing];
    const price = ((precios[`sem_${semana}`]||{})[ing] || 0);
    const cost = meta.totalQty * price;
    compra.push({ingrediente:ing, unidad:meta.unidad, clase:meta.clase, qty:meta.totalQty, precio:price, costo:cost});
  });

  // Build HTML report (daily, week totals, materials, purchase, monthly)
  let html = `<h3>Reporte - Semana ${semana}</h3>`;
  html += `<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px">`;
  // daily cards
  days.forEach(d=>{
    const ds = daySummaries[d];
    html += `<div class="stat"><div><div style="text-transform:capitalize">${d}</div><div class="muted small">${Object.keys(ds.ingredientes).length} insumos</div></div><div><strong>$${ds.totalCost.toFixed(2)}</strong></div></div>`;
  });
  html += `</div>`;

  // table daily detail (first)
  html += `<h4 style="margin-top:12px">Detalle por día</h4>`;
  html += `<table class="compact-table"><thead><tr><th>Día</th><th>Insumo</th><th>Cantidad</th><th>Unidad</th><th>Precio unit.</th><th>Costo</th></tr></thead><tbody>`;
  days.forEach(d=>{
    const ds = daySummaries[d];
    const keys = Object.keys(ds.ingredientes);
    if(keys.length===0){
      html += `<tr><td style="text-align:left">${d}</td><td colspan="5">No planificado</td></tr>`;
    } else {
      keys.forEach((ing,idx)=>{
        const qty = ds.ingredientes[ing];
        const p = ((precios[`sem_${semana}`]||{})[ing] || 0);
        const cost = qty * p;
        html += `<tr><td style="text-align:left">${d}${idx>0?'':''}</td><td style="text-align:left">${ing}</td><td>${qty.toFixed(4)}</td><td>${findIngredientMeta(ing).unidad}</td><td>${p.toFixed(2)}</td><td>${cost.toFixed(2)}</td></tr>`;
      });
    }
  });
  html += `</tbody></table>`;

  // Week totals & materials
  html += `<h4 style="margin-top:12px">Totales semana</h4>`;
  html += `<div style="display:flex;gap:10px;flex-wrap:wrap"><div class="stat" style="min-width:220px;"><div><div>Total semana</div><div class="muted small">Suma de L-V</div></div><div><strong>$${totalSemana.toFixed(2)}</strong></div></div>`;
  html += `<div class="stat" style="min-width:220px;"><div><div>Total mes (últ ${weeksToSum.length} semanas)</div><div class="muted small">Semanas: ${weeksToSum.join(', ')}</div></div><div><strong>$${totalMes.toFixed(2)}</strong></div></div></div>`;

  // Materials used (week)
  html += `<h4 style="margin-top:12px">Materiales usados (semana ${semana})</h4>`;
  html += `<table><thead><tr><th>Clase</th><th>Insumo</th><th>Cantidad total</th><th>Unidad</th></tr></thead><tbody>`;
  Object.keys(ingredientesSemana).sort().forEach(ing=>{
    const r = ingredientesSemana[ing];
    html += `<tr><td>${r.clase}</td><td style="text-align:left">${ing}</td><td>${r.totalQty.toFixed(4)}</td><td>${r.unidad}</td></tr>`;
  });
  html += `</tbody></table>`;

  // Purchase report
  html += `<h4 style="margin-top:12px">Reporte de compra (semana ${semana})</h4>`;
  html += `<table><thead><tr><th>Clase</th><th>Insumo</th><th>Cantidad a comprar</th><th>Unidad</th><th>Precio unit.</th><th>Costo estimado</th></tr></thead><tbody>`;
  compra.sort((a,b)=> a.clase.localeCompare(b.clase) || a.ingrediente.localeCompare(b.ingrediente)).forEach(r=>{
    html += `<tr><td>${r.clase}</td><td style="text-align:left">${r.ingrediente}</td><td>${r.qty.toFixed(4)}</td><td>${r.unidad}</td><td>${r.precio.toFixed(2)}</td><td>${r.costo.toFixed(2)}</td></tr>`;
  });
  const totalCompra = compra.reduce((s,x)=>s+x.costo,0);
  html += `<tr style="font-weight:bold"><td colspan="5">Total compra estimada</td><td>$${totalCompra.toFixed(2)}</td></tr>`;
  html += `</tbody></table>`;

  // Monthly materials summary (last N weeks)
  html += `<h4 style="margin-top:12px">Materiales usados (últ ${weeksToSum.length} semanas)</h4>`;
  html += `<table><thead><tr><th>Clase</th><th>Insumo</th><th>Cantidad total</th><th>Unidad</th></tr></thead><tbody>`;
  Object.keys(ingredientesMes).sort().forEach(ing=>{
    const r = ingredientesMes[ing];
    html += `<tr><td>${r.clase}</td><td style="text-align:left">${ing}</td><td>${r.totalQty.toFixed(4)}</td><td>${r.unidad}</td></tr>`;
  });
  html += `</tbody></table>`;

  // finally set HTML
  document.getElementById('reporteArea').innerHTML = html;
}

/* ================= utility to find ingredient meta ================= */
function findIngredientMeta(name){
  for(const m of MENUS){
    for(const it of m.items){
      if(it.i === name) return { unidad: it.unidad, clase: it.clase };
    }
  }
  // fallback
  return { unidad:'Kg', clase:'Otros' };
}

/* ================= PDF export ================= */
function exportPDF(){
  const content = document.getElementById('reporteArea').innerText;
  if(!content) return alert('Genera el reporte primero');
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation:'portrait',unit:'pt',format:'a4'});
  const margins = {left:40,top:40};
  const textLines = content.split('\n');
  let y = margins.top;
  doc.setFontSize(12);
  textLines.forEach(line=>{
    if(y > 800){ doc.addPage(); y = margins.top; }
    doc.text(line, margins.left, y);
    y += 14;
  });
  const semana = document.getElementById('semanaInput').value;
  doc.save('reporte_semana_'+semana+'.pdf');
}

/* ================= Backup import/export ================= */
function exportBackup(){
  const data = { precios: JSON.parse(localStorage.getItem(LS_KEYS.PRECIOS)||'{}'), plan: JSON.parse(localStorage.getItem(LS_KEYS.PLAN)||'{}') };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'backup_recetario.json'; a.click(); URL.revokeObjectURL(url);
}

function importBackup(){
  const input = document.createElement('input'); input.type='file'; input.accept='application/json';
  input.onchange = e=>{
    const file = e.target.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const obj = JSON.parse(reader.result);
        if(obj.precios) localStorage.setItem(LS_KEYS.PRECIOS, JSON.stringify(obj.precios));
        if(obj.plan) localStorage.setItem(LS_KEYS.PLAN, JSON.stringify(obj.plan));
        alert('Backup importado. Recarga la página.'); location.reload();
      }catch(err){ alert('JSON inválido'); }
    };
    reader.readAsText(file);
  };
  input.click();
}

/* ================= misc handlers ================= */
document.getElementById('cargarSemana').addEventListener('click', renderPreciosTable);
document.getElementById('guardarPrecios').addEventListener('click', guardarPrecios);
document.getElementById('toggleAuto').addEventListener('click', ()=>{
  autoSave = !autoSave;
  document.getElementById('toggleAuto').textContent = 'Auto-guardar: '+ (autoSave? 'ON':'OFF');
  if(autoSave) guardarPrecios();
});
document.getElementById('guardarDia').addEventListener('click', guardarDia);
document.getElementById('cargarDia').addEventListener('click', cargarDia);
document.getElementById('generarReporte').addEventListener('click', generarReporte);
document.getElementById('exportPDF').addEventListener('click', exportPDF);
document.getElementById('limpiarDatos').addEventListener('click', ()=>{ if(confirm('Borrar todos los datos guardados?')){ localStorage.removeItem(LS_KEYS.PRECIOS); localStorage.removeItem(LS_KEYS.PLAN); document.getElementById('reporteArea').innerHTML=''; alert('Datos eliminados'); } });
document.getElementById('exportBackup').addEventListener('click', exportBackup);
document.getElementById('importBackup').addEventListener('click', importBackup);

/* init */
initUI();
</script>
</body>
</html>
